# 18S Dataset

## üì¶ Build the phyloseq object (16S)

```{r, message=FALSE, warning=FALSE}
library(tidyverse)
library(phyloseq)

# ---- paths ----
datadir <- "data/18S"

# ---- load DADA2 outputs ----
seqtab.nochim <- readRDS(file.path(datadir, "seqtab_nochim.rds"))
taxa          <- readRDS(file.path(datadir, "taxa.rds"))

# Make sure taxonomy is a proper matrix and has consistent column names
taxa <- as.matrix(taxa)
target_cols <- c(
  "Kingdom","Subkingdom_1","Subkingdom_2","Phylum","Subphylum","Subphylum_1","Superclass",
  "Class","Subclass","Infraclass","Superorder","Order","Suborder_1","Suborder_2","Suborder_3",
  "Family","Subfamily","Genus","Subgenus","Species"
)
colnames(taxa) <- target_cols[seq_len(ncol(taxa))]

# Load metadata
metadat <- readxl::read_xlsx(file.path(datadir, "metadata_18S.xlsx")) %>%
  mutate(
    Date = as.Date(as.numeric(Date), origin = "1899-12-30"),
    Time = as.POSIXct(as.numeric(Time) * 86400, origin = "1970-01-01", tz = "UTC"),
    Time = format(Time, "%H:%M:%S")
  ) %>% as.data.frame()

rownames(metadat) <- rownames(seqtab.nochim)

# Create a Phyloseq object

ps_18s <- phyloseq(otu_table(seqtab.nochim, taxa_are_rows = F), 
               sample_data(metadat), 
               tax_table(taxa))
saveRDS(ps_18s, "data/ps_18s.rds")
  
cat("üîπ A summary of the phyloseq object \n")
ps_18s

# storing the ASV sequences and assigning them with a name and then renaming the taxa object
dna <- Biostrings::DNAStringSet(taxa_names(ps_18s))
names(dna) <- taxa_names(ps_18s)
ps_18s <- merge_phyloseq(ps_18s, dna)
taxa_names(ps_18s) <- paste0("ASV", seq(ntaxa(ps_18s)))

```
```{r, echo=FALSE, message=FALSE, warning=FALSE}
# Print sample names, taxonomy ranks, and metadata fields ‚Äî with explanations
cat("üîπ These are the metadata variables:\n")
print(sample_variables(ps_18s))
```

## üìä Data visualisation

In this section, we explore the community structure of the RoCSI 18S dataset using the
`phyloseq` object (`ps_18s`) generated above. We start by visualising read depth
per sample, followed by basic taxonomic composition summaries.

### Read depth per sample
```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.width=10, fig.height=8}
read_depth <- data.frame(
Sample = sample_names(ps_18s),
Reads = sample_sums(ps_18s),
check.names = FALSE
)

ggplot(read_depth, aes(x = Sample, y = Reads)) +
geom_col() +
theme_minimal() + scale_y_continuous(labels = scales::label_number()) +
theme(axis.text.x = element_text(angle = 45, hjust = 1)) + # Rotate x-axis labels for better readability
scale_x_discrete(
    labels = function(x) substr(x, 1, 6), # Show only the first 5 characters of each label
    breaks = function(x) x[seq(1, length(x), by = 4)] # Show every 4th label
  ) +
labs(
title = "Sequencing depth per sample",
x = "Sample",
y = "Number of non-chimeric reads"
)
```

### Alpha diversity

```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.width=10, fig.height=8}


# Make sure Water_masses is a factor (optional, but useful for consistent plotting)
sample_data(ps_18s)$Fjord <- as.factor(sample_data(ps_18s)$Fjord)

plot_richness(
  ps_18s,
  x = "Number",
  measures = c("Observed", "Shannon", "Simpson"),
  color = "Fjord", title = "18S Alpha diversity")

```
::: {.callout-note}
### üí¨ Discussion ‚Äî Alpha diversity patterns

Alpha diversity of 18S eukaryotic communities varied among fjords, with Ocean and Tunulliarfik samples generally exhibiting higher richness compared to Sermilik. Shannon and Simpson indices indicate relatively high evenness across most samples, although occasional dominance events were observed (diversity drops), particularly in Sermilik and Tunulliarfik. Compared to 16S prokaryotic diversity, 18S communities displayed greater variability among fjords, suggesting that eukaryotic plankton communities may be more sensitive to local environmental gradients such as stratification and meltwater influence.  
:::

```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.width=10, fig.height=8}


# Make sure Water_masses is a factor (optional, but useful for consistent plotting)
sample_data(ps_18s)$Fjord <- as.factor(sample_data(ps_18s)$Fjord)
sample_data(ps_18s)$Depth <- as.factor(sample_data(ps_18s)$Depth)

plot_richness(
  ps_18s,
  x = "Number",
  measures = c("Observed", "Shannon", "Simpson"),
  color = "Depth", title = "18S Alpha diversity")

```

::: {.callout-note}
### üí¨ Discussion ‚Äî Alpha diversity patterns
No obvious trends with depth... Maybe surface water tend to exhibit lower diversity...
:::

### Ordination

```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.width=10, fig.height=8}
ord <- ordinate(ps_18s, method = "PCoA", distance = "bray")

# Create the ordination plot with ellipses
plot_ordination(ps_18s, ord, color = "Fjord") +
  geom_point(size = 3) +
  ggtitle("Ordination ‚Äì 18S") +
  stat_ellipse(aes(group = Fjord), type = "norm", linetype = "dashed", size = 1) +
  theme_minimal()
```
::: {.callout-note}
### üí¨ Discussion ‚Äî Beta diversity

The 18S ordination reveals partial clustering by fjord but with substantial overlap among systems. Compared to the 16S bacterial communities, eukaryotic assemblages show greater within-fjord variability and weaker separation among fjords. Tunulliarfik displays the highest dispersion, consistent with elevated alpha diversity and environmental heterogeneity. Overall, these results suggest that while fjord identity influences eukaryotic community structure, planktonic assemblages may be shaped more strongly by shared regional drivers such as stratification and bloom dynamics than by fjord-specific environmental filtering alone.
:::

```{r, echo=FALSE, message=FALSE, warning=FALSE}
# Extract sample coordinates from the PCoA result
site <- as.data.frame(ord$vectors)
site$SampleID <- rownames(site)

# Get the 5 lowest values on Axis.1 (side of plot)
bottom5 <- site[order(site$Axis.1), ][1:5, c("SampleID", "Axis.1", "Axis.2")]
bottom5
```

::: {.callout-note}
Again, the most divergent samples in the ordination correspond exclusively to surface (D1) samples. Particularly they are the stations surrounded by icebergs (Fjord Sermilik and Tunulliarfik). These stations were influenced by meltwater and low salinity conditions, suggesting that surface stratification and freshwater input may exert a strong effect on eukaryotic community composition.
:::


### Phylum composition

```{r echo=FALSE, message=FALSE, warning=FALSE, fig.width=10, fig.height=8}
my_colors <- c("#FF6666", "#8DD3C7", "#377EB8", "#4DAF4A",
               "#984EA3", "#A6D854", "#FFFF33", "#FF7F00", "#F781BF", "#999999",                  "#66C2A5", "#FC8D62", "#8DA0CB", "#E78AC3", "#FFD92F",
               "#E5C494", "#B3B3B3", "#A65628","#FFFFB3", "#BEBADA",
               "#FB8072", "#80B1D3", "#FDB462")

library(microbiome)

# 1) Agglomerate to Phylum
ps_phylum <- tax_glom(ps_18s, taxrank = "Phylum")

# 2) Transform to relative abundance (compositional)
ps_rel <- microbiome::transform(ps_phylum, "compositional")

# 3) Top 20 taxa by mean relative abundance (returns taxa_names / OTU IDs)
top20 <- microbiome::top_taxa(ps_rel, n = 20)

# 4) Melt full object
df <- psmelt(ps_rel)

# Ensure Phylum label exists and is character (handles NAs)
df <- df %>%
  mutate(
    Phylum = as.character(Phylum),
    Phylum = if_else(is.na(Phylum) | Phylum == "", "Unassigned", Phylum),
    Phylum_plot = if_else(OTU %in% top20, Phylum, "Other")
  ) %>%
  group_by(Sample, Number, Phylum_plot) %>%
  summarise(Abundance = sum(Abundance), .groups = "drop")

# Put "Other" at the end of the legend
df$Phylum_plot <- factor(
  df$Phylum_plot,
  levels = c(setdiff(unique(df$Phylum_plot), "Other"), "Other")
)

# 5) Colors: 20 phyla + Other
other_color <- "#C0C0C0"
plot_colors <- c(my_colors[1:20], other_color)

# Optional: make sure color vector matches factor levels exactly
levels_phylum <- levels(df$Phylum_plot)
names(plot_colors) <- levels_phylum  # map colors to labels

# 6) Plot
ggplot(df, aes(x = Number, y = Abundance, fill = Phylum_plot)) +
  geom_col(width = 0.8) +
  scale_fill_manual(values = plot_colors) +
  scale_y_continuous(labels = scales::percent) +
  labs(
    title = "Eukaryote Phyla (Top 20 + Other)",
    x = "Sample Number",
    y = "Relative abundance (%)",
    fill = "Phylum"
  ) +
  theme_classic() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    legend.position = "bottom",
    legend.direction = "horizontal"
  ) +
  guides(fill = guide_legend(nrow = 3))   # increase if still crowded

```

::: {.callout-note}
### üí¨ Discussion ‚Äî Phyla composition

At the Phylum level, eukaryotic communities are strongly dominated by **Myzozoa**, likely **dinoflagellate lineages**, across most samples. **Bacillariophyta (diatoms)** and **Chlorophyta (green algae)** contribute variably among samples, reflecting potential shifts in primary producer composition.
:::

```{r echo=FALSE, message=FALSE, warning=FALSE, fig.width=10, fig.height=8}

# 1Ô∏è‚É£ Collapse to Class level
ps_Class <- tax_glom(ps_18s, taxrank = "Class")

# 2Ô∏è‚É£ Transform to relative abundance
ps_rel <- transform(ps_Class, "compositional")

# 3Ô∏è‚É£ Get top 10 classes (by mean relative abundance)
top10 <- top_taxa(ps_rel, n = 10)

# 4Ô∏è‚É£ Melt full dataset
df <- psmelt(ps_rel)
df$Number <- as.factor(df$Number)

# 5Ô∏è‚É£ Create Class_plot column (Top 10 + Other)
df <- df %>%
  mutate(
    Class = as.character(Class),
    Class = if_else(is.na(Class) | Class == "", "Unclassified", Class),
    Class_plot = if_else(OTU %in% top10, Class, "Other")
  ) %>%
  group_by(Sample, Number, Class_plot) %>%
  summarise(Abundance = sum(Abundance), .groups = "drop")

# 6Ô∏è‚É£ Put "Other" at the end of legend
df$Class_plot <- factor(
  df$Class_plot,
  levels = c(setdiff(sort(unique(df$Class_plot)), "Other"), "Other")
)

# 7Ô∏è‚É£ Use your my_colors (first 10) + grey for Other
other_color <- "#C0C0C0"
plot_colors <- c(my_colors[1:10], other_color)
names(plot_colors) <- levels(df$Class_plot)

# 8Ô∏è‚É£ Plot
ggplot(df, aes(x = Number, y = Abundance, fill = Class_plot)) +
  geom_bar(stat = "identity", position = "stack") +
  scale_fill_manual(values = plot_colors) + 
  scale_y_continuous(labels = scales::percent) +
  labs(
    title = "Top 10 classes + Other",
    x = "Sample Number",
    y = "Relative Abundance (%)",
    fill = "Class"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    legend.position = "bottom"
  ) +
  guides(fill = guide_legend(nrow = 2, byrow = TRUE)) +
  scale_x_discrete(
    labels = function(x) substr(x, 1, 5),
    breaks  = function(x) x[seq(1, length(x), by = 4)]
  )
```
::: {.callout-note}
### üí¨ Discussion ‚Äî Class composition

At the Class level, eukaryotic communities were strongly dominated by **Dinozoa (dinoflagellates)** across most samples, with episodic increases in **Bacillariophytina (diatoms) and Crustacea**. These patterns suggest that **dinoflagellates** and associated trophic interactions **play a central role** in structuring the planktonic community. Compared to bacterial communities, 18S profiles exhibit stronger dominance patterns and greater patchiness.
:::


### Plotting by fjords and depth
#### Sermilik

```{r echo=FALSE, message=FALSE, warning=FALSE, fig.width=10, fig.height=8}

# Collapse + compositional
ps_Class <- tax_glom(ps_18s, taxrank = "Class")
ps_rel   <- transform(ps_Class, "compositional")

# Top 10 taxa (OTU/ASV IDs after glomming)
top10 <- top_taxa(ps_rel, n = 10)

# Melt full object
df <- psmelt(ps_rel)

# Make Depth nice (adapt if your Depth column differs)
df <- df %>%
  mutate(
    Depth = as.character(Depth),
    Depth = if_else(Depth %in% c("1","01","surface","Surface"), "surface",
             if_else(Depth %in% c("15","15m","15 m"), "15m",
             if_else(Depth %in% c("45","45m","45 m"), "45m", Depth))),
    Depth = factor(Depth, levels = c("surface", "15m", "45m")),
    Fjord = as.factor(Fjord)
  )

# Top10 + Other
df <- df %>%
  mutate(
    Class = as.character(Class),
    Class = if_else(is.na(Class) | Class == "", "Unclassified", Class),
    Class_plot = if_else(OTU %in% top10, Class, "Other")
  ) %>%
  group_by(Fjord, Depth, Sample, Number, Station, Class_plot) %>%
  summarise(Abundance = sum(Abundance), .groups = "drop")

# Legend order: Other last
df$Class_plot <- factor(
  df$Class_plot,
  levels = c(setdiff(sort(unique(df$Class_plot)), "Other"), "Other")
)

# Colors: use your palette (first 10) + Other
other_color <- "#C0C0C0"
plot_colors <- c(my_colors[1:10], other_color)
names(plot_colors) <- levels(df$Class_plot)

plot_fjord <- function(df, fjord_name){
  dff <- df %>% filter(Fjord == fjord_name)

  ggplot(dff, aes(x = Station, y = Abundance, fill = Class_plot)) +
    geom_col(width = 0.85) +
    facet_wrap(~Depth, nrow = 1) +
    scale_fill_manual(values = plot_colors) +
    scale_y_continuous(labels = scales::percent) +
    labs(
      title = paste0(fjord_name, " ‚Äî Top 10 Classes + Other"),
      x = "Station Number",
      y = "Relative abundance",
      fill = "Class"
    ) +
    theme_classic() +
    theme(
      legend.position = "bottom",
      strip.background = element_rect(fill = "white"),
      strip.text = element_text(face = "bold")
    ) +
    guides(fill = guide_legend(nrow = 2, byrow = TRUE)) 
}

fjords <- sort(unique(df$Fjord))

plots <- lapply(fjords, function(fj) plot_fjord(df, fj))
names(plots) <- as.character(fjords)

# Print one (e.g., Sermilik)
plots[["Sermilik"]]


```

#### Iterdalk

```{r echo=FALSE, message=FALSE, warning=FALSE, fig.width=10, fig.height=8}
plots[["Iterdalk"]]

```

#### Tunulliarfik

```{r echo=FALSE, message=FALSE, warning=FALSE, fig.width=10, fig.height=8}
plots[["Tunulliarfik"]]

```


#### Ocean

```{r echo=FALSE, message=FALSE, warning=FALSE, fig.width=10, fig.height=8}
plots[["Ocean"]]

```


