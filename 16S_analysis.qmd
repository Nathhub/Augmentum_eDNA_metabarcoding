# 16S Dataset

## üì¶ Build the phyloseq object (16S)

```{r, message=FALSE, warning=FALSE}
library(tidyverse)
library(phyloseq)

# ---- paths ----
datadir <- "data/16S"

# ---- load DADA2 outputs ----
seqtab.nochim <- readRDS(file.path(datadir, "seqtab_nochim.rds"))
taxa          <- readRDS(file.path(datadir, "taxa.rds"))

# Load metadata
metadat <- readxl::read_xlsx(file.path(datadir, "metadata_16S.xlsx")) %>%
  mutate(
    Date = as.Date(as.numeric(Date), origin = "1899-12-30"),
    Time = as.POSIXct(as.numeric(Time) * 86400, origin = "1970-01-01", tz = "UTC"),
    Time = format(Time, "%H:%M:%S")
  ) %>% as.data.frame()

rownames(metadat) <- rownames(seqtab.nochim)

# Create a Phyloseq object

ps_16s <- phyloseq(otu_table(seqtab.nochim, taxa_are_rows = F), 
               sample_data(metadat), 
               tax_table(taxa))
saveRDS(ps_16s, "data/ps_16s.rds")
  
cat("üîπ A summary of the phyloseq object \n")
ps_16s

# storing the ASV sequences and assigning them with a name and then renaming the taxa object
dna <- Biostrings::DNAStringSet(taxa_names(ps_16s))
names(dna) <- taxa_names(ps_16s)
ps_16s <- merge_phyloseq(ps_16s, dna)
taxa_names(ps_16s) <- paste0("ASV", seq(ntaxa(ps_16s)))

```
```{r, echo=FALSE, message=FALSE, warning=FALSE}
# Print sample names, taxonomy ranks, and metadata fields ‚Äî with explanations
cat("üîπ These are the metadata variables:\n")
print(sample_variables(ps_16s))
```

## üìä Data visualisation

In this section, we explore the community structure of the RoCSI 16S dataset using the
`phyloseq` object (`ps_16s`) generated above. We start by visualising read depth
per sample, followed by basic taxonomic composition summaries.

### Read depth per sample
```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.width=10, fig.height=8}
read_depth <- data.frame(
Sample = sample_names(ps_16s),
Reads = sample_sums(ps_16s),
check.names = FALSE
)

ggplot(read_depth, aes(x = Sample, y = Reads)) +
geom_col() +
theme_minimal() + scale_y_continuous(labels = scales::label_number()) +
theme(axis.text.x = element_text(angle = 45, hjust = 1)) + # Rotate x-axis labels for better readability
scale_x_discrete(
    labels = function(x) substr(x, 1, 6), # Show only the first 5 characters of each label
    breaks = function(x) x[seq(1, length(x), by = 4)] # Show every 4th label
  ) +
labs(
title = "Sequencing depth per sample",
x = "Sample",
y = "Number of non-chimeric reads"
)
```

### Positive and negative control

```{r, echo=FALSE, message=FALSE, warning=FALSE}

ps_controls <- subset_samples(
  ps_16s,
  Name %in% c("65_zymo_positive", "66_Extraction_negative")
)

ps_controls <- prune_taxa(taxa_sums(ps_controls) > 0, ps_controls)
cat("Number of reads in the controls:\n")
sample_sums(ps_controls)
```
```{r, echo=FALSE, message=FALSE, warning=FALSE}

estimate_richness(ps_controls, measures = "Observed")

```

::: {.callout-note}
### üí¨ Discussion ‚Äî Controls

Excellent! Those control numbers are actually very reassuring:

**Positive control**: 733,263 reads, 14 ASVs ‚Üí perfectly reasonable (mock community). However, it's a bit more than expected

**Extraction negative**: 4 reads, 4 ASVs ‚Üí essentially clean (background noise).
  
:::

```{r, echo=FALSE, message=FALSE, warning=FALSE}

df_controls <- psmelt(ps_controls)

df_controls %>%
  group_by(Sample, Family) %>%
  summarise(Abundance = sum(Abundance)) %>%
  arrange(Sample, desc(Abundance)) %>%
  head(10)

```

::: {.callout-note}
### üí¨ Discussion ‚Äî Positive Controls : **ZymoBIOMICS Microbial Standard**

From the table above, we can ignore the ASVs that have low abundance (noise). We therefore have ASVs that match 7 families.

From the Zymo standard, we are expecting 8 bacteria:

ü¶† Bacteria species:
- Pseudomonas aeruginosa
- Escherichia coli
- Salmonella enterica
- Lactobacillus fermentum
- Enterococcus faecalis
- Staphylococcus aureus
- Listeria monocytogenes
- Bacillus subtilis

:::

```{r, echo=FALSE, message=FALSE, warning=FALSE}
df_controls %>%
  group_by(Sample, Genus) %>%
  summarise(Abundance = sum(Abundance)) %>%
  arrange(Sample, desc(Abundance)) %>%
  head(9)

```
::: {.callout-note}
### üí¨ Discussion ‚Äî Controls Conclusion

The ZymoBIOMICS Microbial Community Standard positive control performed as expected. All eight bacterial genera included in the mock community were successfully recovered.The relative abundances of recovered taxa were broadly consistent with expected composition, although minor deviations were observed, likely reflecting known amplification biases associated with 16S rRNA gene primers.

A small proportion (~1%) of reads were assigned to Enterobacteriaceae without genus-level resolution, likely reflecting limitations of the amplified 16S region or conservative classification thresholds.

Overall, these results confirm the reliability of amplification, sequencing, and taxonomic assignment in the 16S workflow.

We can now remove the controls from the phyloseq object and move on with the ecological interpretation.
:::

```{r, echo=FALSE, message=FALSE, warning=FALSE}
ps_16s <- subset_samples(
  ps_16s,
  !Name %in% c("65_zymo_positive", "66_Extraction_negative")
)

# Prune zero-abundance taxa
ps_16s <- prune_taxa(taxa_sums(ps_16s) > 0, ps_16s)
```


### Alpha diversity

```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.width=10, fig.height=8}


# Make sure Water_masses is a factor (optional, but useful for consistent plotting)
sample_data(ps_16s)$Fjord <- as.factor(sample_data(ps_16s)$Fjord)

plot_richness(
  ps_16s,
  x = "Number",
  measures = c("Observed", "Shannon", "Simpson"),
  color = "Fjord", title = "16S Alpha diversity") +
  scale_x_discrete(breaks = function(x) x[seq(1, length(x), by = 4)]) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```
::: {.callout-note}
### üí¨ Discussion ‚Äî Alpha diversity patterns

Observed richness (number of ASVs), Shannon and Simpson diversity are fairly similar across fjords and the ocean samples.
  
:::

```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.width=10, fig.height=8}


# Make sure Water_masses is a factor (optional, but useful for consistent plotting)
sample_data(ps_16s)$Fjord <- as.factor(sample_data(ps_16s)$Fjord)
sample_data(ps_16s)$Depth <- as.factor(sample_data(ps_16s)$Depth)

plot_richness(
  ps_16s,
  x = "Number",
  measures = c("Observed", "Shannon", "Simpson"),
  color = "Depth", title = "16S Alpha diversity") +
  scale_x_discrete(breaks = function(x) x[seq(1, length(x), by = 4)]) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))


```

::: {.callout-note}
### üí¨ Discussion ‚Äî Alpha diversity patterns

Observed richness (number of ASVs) tend to be increasing with depth.
:::

### Ordination

```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.width=10, fig.height=8}
ord <- ordinate(ps_16s, method = "PCoA", distance = "bray")

# Create the ordination plot with ellipses
plot_ordination(ps_16s, ord, color = "Fjord") +
  geom_point(size = 3) +
  ggtitle("Ordination ‚Äì 16S") +
  stat_ellipse(aes(group = Fjord), type = "norm", linetype = "dashed", size = 1) +
  theme_minimal()
```
::: {.callout-note}
### üí¨ Discussion ‚Äî Beta diversity

The ordination shows **clustering of samples by fjord**, indicating fjord-level structuring of bacterial communities. Sermilik forms a relatively distinct and tightly clustered group, whereas Tunulliarfik exhibits greater within-fjord variability. Notably, there is considerable overlap between Itterdalk and Tunulliarfik, suggesting partial similarity in community composition and potentially shared environmental controls. Ocean samples occupy an intermediate position, consistent with coastal waters acting as a regional microbial source pool. Overall, **fjord identity contributes to community differentiation**, although separation is not absolute among all systems.

Next: check if dispersion differs significantly? 
betadisper(...)
permutest(...)

**NOTE**: some samples are pretty distant from the othesr. Who are they?
:::

```{r, echo=FALSE, message=FALSE, warning=FALSE}
# Extract sample coordinates from the PCoA result
site <- as.data.frame(ord$vectors)
site$SampleID <- rownames(site)

# Get the 5 lowest values on Axis.1 (side of plot)
bottom5 <- site[order(site$Axis.1), ][1:5, c("SampleID", "Axis.1", "Axis.2")]
bottom5
```

::: {.callout-note}
The most divergent samples in the ordination correspond exclusively to surface (D1) samples. These stations were influenced by meltwater and low salinity conditions, suggesting that surface stratification and freshwater input may exert a strong effect on microbial community composition. This pattern indicates that vertical position and freshwater influence may be key drivers of community differentiation in these fjord systems.
:::


### Phylum composition

```{r echo=FALSE, message=FALSE, warning=FALSE, fig.width=10, fig.height=8}
my_colors <- c("#FF6666", "#8DD3C7", "#377EB8", "#4DAF4A",
               "#984EA3", "#A6D854", "#FFFF33", "#FF7F00", "#F781BF", "#999999",                  "#66C2A5", "#FC8D62", "#8DA0CB", "#E78AC3", "#FFD92F",
               "#E5C494", "#B3B3B3", "#A65628","#FFFFB3", "#BEBADA",
               "#FB8072", "#80B1D3", "#FDB462")

library(microbiome)

# 1) Agglomerate to Phylum
ps_phylum <- tax_glom(ps_16s, taxrank = "Phylum")

# 2) Transform to relative abundance (compositional)
ps_rel <- microbiome::transform(ps_phylum, "compositional")

# 3) Top 20 taxa by mean relative abundance (returns taxa_names / OTU IDs)
top20 <- microbiome::top_taxa(ps_rel, n = 20)

# 4) Melt full object
df <- psmelt(ps_rel)

# Ensure Phylum label exists and is character (handles NAs)
df <- df %>%
  mutate(
    Phylum = as.character(Phylum),
    Phylum = if_else(is.na(Phylum) | Phylum == "", "Unassigned", Phylum),
    Phylum_plot = if_else(OTU %in% top20, Phylum, "Other")
  ) %>%
  group_by(Sample, Number, Phylum_plot) %>%
  summarise(Abundance = sum(Abundance), .groups = "drop")

# Put "Other" at the end of the legend
df$Phylum_plot <- factor(
  df$Phylum_plot,
  levels = c(setdiff(unique(df$Phylum_plot), "Other"), "Other")
)

# 5) Colors: 20 phyla + Other
other_color <- "#C0C0C0"
plot_colors <- c(my_colors[1:20], other_color)

# Optional: make sure color vector matches factor levels exactly
levels_phyla <- levels(df$Phylum_plot)
names(plot_colors) <- levels_phyla  # map colors to labels

# 6) Plot
ggplot(df, aes(x = Number, y = Abundance, fill = Phylum_plot)) +
  geom_col(width = 0.8) +
  scale_fill_manual(values = plot_colors) +
  scale_y_continuous(labels = scales::percent) +
  labs(
    title = "Bacteria/Archaea Phyla (Top 20 + Other)",
    x = "Sample Number",
    y = "Relative abundance (%)",
    fill = "Phylum"
  ) +
  theme_classic() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    legend.position = "bottom",
    legend.direction = "horizontal"
  ) +
  guides(fill = guide_legend(nrow = 5))   # increase if still crowded


```

::: {.callout-note}
### üí¨ Discussion ‚Äî Phyla composition

The bacterial community across samples is dominated by **Pseudomonadota**, with consistent contributions from **Bacteroidota** and **Cyanobacteriota**. Minor but **detectable archaeal phyla** were present at low relative abundance. Overall community structure is broadly similar across samples.
:::

```{r echo=FALSE, message=FALSE, warning=FALSE, fig.width=10, fig.height=8}

# 1Ô∏è‚É£ Collapse to Class level
ps_class <- tax_glom(ps_16s, taxrank = "Class")

# 2Ô∏è‚É£ Transform to relative abundance
ps_rel <- transform(ps_class, "compositional")

# 3Ô∏è‚É£ Get top 10 classes (by mean relative abundance)
top10 <- top_taxa(ps_rel, n = 10)

# 4Ô∏è‚É£ Melt full dataset
df <- psmelt(ps_rel)
df$Number <- as.factor(df$Number)

# 5Ô∏è‚É£ Create Class_plot column (Top 10 + Other)
df <- df %>%
  mutate(
    Class = as.character(Class),
    Class = if_else(is.na(Class) | Class == "", "Unclassified", Class),
    Class_plot = if_else(OTU %in% top10, Class, "Other")
  ) %>%
  group_by(Sample, Number, Class_plot) %>%
  summarise(Abundance = sum(Abundance), .groups = "drop")

# 6Ô∏è‚É£ Put "Other" at the end of legend
df$Class_plot <- factor(
  df$Class_plot,
  levels = c(setdiff(sort(unique(df$Class_plot)), "Other"), "Other")
)

# 7Ô∏è‚É£ Use your my_colors (first 10) + grey for Other
other_color <- "#C0C0C0"
plot_colors <- c(my_colors[1:10], other_color)
names(plot_colors) <- levels(df$Class_plot)

# 8Ô∏è‚É£ Plot
ggplot(df, aes(x = Number, y = Abundance, fill = Class_plot)) +
  geom_bar(stat = "identity", position = "stack") +
  scale_fill_manual(values = plot_colors) + 
  scale_y_continuous(labels = scales::percent) +
  labs(
    title = "Top 10 Classes + Other",
    x = "Sample Number",
    y = "Relative Abundance (%)",
    fill = "Class"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    legend.position = "bottom"
  ) +
  guides(fill = guide_legend(nrow = 2, byrow = TRUE))
```
::: {.callout-note}
### üí¨ Discussion ‚Äî Class composition


:::


### Plotting by fjords and depth
#### Sermilik

```{r echo=FALSE, message=FALSE, warning=FALSE, fig.width=10, fig.height=8}

# Collapse + compositional
ps_class <- tax_glom(ps_16s, taxrank = "Class")
ps_rel   <- transform(ps_class, "compositional")

# Top 10 taxa (OTU/ASV IDs after glomming)
top10 <- top_taxa(ps_rel, n = 10)

# Melt full object
df <- psmelt(ps_rel)

# Make Depth nice (adapt if your Depth column differs)
df <- df %>%
  mutate(
    Depth = as.character(Depth),
    Depth = if_else(Depth %in% c("1","01","surface","Surface"), "surface",
             if_else(Depth %in% c("15","15m","15 m"), "15m",
             if_else(Depth %in% c("45","45m","45 m"), "45m", Depth))),
    Depth = factor(Depth, levels = c("surface", "15m", "45m")),
    Fjord = as.factor(Fjord)
  )

# Top10 + Other
df <- df %>%
  mutate(
    Class = as.character(Class),
    Class = if_else(is.na(Class) | Class == "", "Unclassified", Class),
    Class_plot = if_else(OTU %in% top10, Class, "Other")
  ) %>%
  group_by(Fjord, Depth, Sample, Number, Station, Class_plot) %>%
  summarise(Abundance = sum(Abundance), .groups = "drop")

# Legend order: Other last
df$Class_plot <- factor(
  df$Class_plot,
  levels = c(setdiff(sort(unique(df$Class_plot)), "Other"), "Other")
)

# Colors: use your palette (first 10) + Other
other_color <- "#C0C0C0"
plot_colors <- c(my_colors[1:10], other_color)
names(plot_colors) <- levels(df$Class_plot)

plot_fjord <- function(df, fjord_name){
  dff <- df %>% filter(Fjord == fjord_name)

  ggplot(dff, aes(x = Station, y = Abundance, fill = Class_plot)) +
    geom_col(width = 0.85) +
    facet_wrap(~Depth, nrow = 1) +
    scale_fill_manual(values = plot_colors) +
    scale_y_continuous(labels = scales::percent) +
    labs(
      title = paste0(fjord_name, " ‚Äî Top 10 Classes + Other"),
      x = "Station Number",
      y = "Relative abundance",
      fill = "Class"
    ) +
    theme_classic() +
    theme(
      legend.position = "bottom",
      axis.text.x = element_text(angle = 45, hjust = 1),
      strip.background = element_rect(fill = "white"),
      strip.text = element_text(face = "bold")
    ) +
    guides(fill = guide_legend(nrow = 2, byrow = TRUE))
}

fjords <- sort(unique(df$Fjord))

plots <- lapply(fjords, function(fj) plot_fjord(df, fj))
names(plots) <- as.character(fjords)

# Print one (e.g., Sermilik)
plots[["Sermilik"]]


```

#### Iterdalk

```{r echo=FALSE, message=FALSE, warning=FALSE, fig.width=10, fig.height=8}
plots[["Iterdalk"]]

```

#### Tunulliarfik

```{r echo=FALSE, message=FALSE, warning=FALSE, fig.width=10, fig.height=8}
plots[["Tunulliarfik"]]

```


#### Ocean

```{r echo=FALSE, message=FALSE, warning=FALSE, fig.width=10, fig.height=8}
plots[["Ocean"]]

```


