# 16S Dataset

## ðŸ“¦ Build the phyloseq object (16S)

```{r, message=FALSE, warning=FALSE}
library(tidyverse)
library(phyloseq)

# ---- paths ----
datadir <- "data/16S"

# ---- load DADA2 outputs ----
seqtab.nochim <- readRDS(file.path(datadir, "seqtab_nochim.rds"))
taxa          <- readRDS(file.path(datadir, "taxa.rds"))

# Load metadata
metadat <- readxl::read_xlsx(file.path(datadir, "metadata_16S.xlsx")) %>%
  mutate(
    Date = as.Date(as.numeric(Date), origin = "1899-12-30"),
    Time = as.POSIXct(as.numeric(Time) * 86400, origin = "1970-01-01", tz = "UTC"),
    Time = format(Time, "%H:%M:%S")
  ) %>% as.data.frame()

rownames(metadat) <- rownames(seqtab.nochim)

# Create a Phyloseq object

ps_16s <- phyloseq(otu_table(seqtab.nochim, taxa_are_rows = F), 
               sample_data(metadat), 
               tax_table(taxa))
saveRDS(ps_16s, "data/ps_16s.rds")
  
cat("ðŸ”¹ A summary of the phyloseq object \n")
ps_16s

# storing the ASV sequences and assigning them with a name and then renaming the taxa object
dna <- Biostrings::DNAStringSet(taxa_names(ps_16s))
names(dna) <- taxa_names(ps_16s)
ps_16s <- merge_phyloseq(ps_16s, dna)
taxa_names(ps_16s) <- paste0("ASV", seq(ntaxa(ps_16s)))

```
```{r, echo=FALSE, message=FALSE, warning=FALSE}
# Print sample names, taxonomy ranks, and metadata fields â€” with explanations
cat("ðŸ”¹ These are the metadata variables:\n")
print(sample_variables(ps_16s))
```

## ðŸ“Š Data visualisation

In this section, we explore the community structure of the RoCSI 16S dataset using the
`phyloseq` object (`ps_16s`) generated above. We start by visualising read depth
per sample, followed by basic taxonomic composition summaries.

### Read depth per sample
```{r, echo=FALSE, message=FALSE, warning=FALSE}
read_depth <- data.frame(
Sample = sample_names(ps_16s),
Reads = sample_sums(ps_16s),
check.names = FALSE
)

ggplot(read_depth, aes(x = Sample, y = Reads)) +
geom_col() +
theme_minimal() + scale_y_continuous(labels = scales::label_number()) +
theme(axis.text.x = element_text(angle = 45, hjust = 1)) + # Rotate x-axis labels for better readability
scale_x_discrete(
    labels = function(x) substr(x, 1, 6), # Show only the first 5 characters of each label
    breaks = function(x) x[seq(1, length(x), by = 4)] # Show every 4th label
  ) +
labs(
title = "Sequencing depth per sample",
x = "Sample",
y = "Number of non-chimeric reads"
)
```

### Alpha diversity

```{r, echo=FALSE, message=FALSE, warning=FALSE}


# Make sure Water_masses is a factor (optional, but useful for consistent plotting)
sample_data(ps_16s)$Fjord <- as.factor(sample_data(ps_16s)$Fjord)

plot_richness(
  ps_16s,
  x = "Number",
  measures = c("Observed", "Shannon", "Simpson"),
  color = "Fjord", title = "16S Alpha diversity")

```
::: {.callout-note}
### ðŸ’¬ Discussion â€” Alpha diversity patterns

Observed richness (number of ASVs), Shannon and Simpson diversity are fairly similar across fjords and the ocean samples.
  
:::

```{r, echo=FALSE, message=FALSE, warning=FALSE}


# Make sure Water_masses is a factor (optional, but useful for consistent plotting)
sample_data(ps_16s)$Fjord <- as.factor(sample_data(ps_16s)$Fjord)
sample_data(ps_16s)$Depth <- as.factor(sample_data(ps_16s)$Depth)

plot_richness(
  ps_16s,
  x = "Number",
  measures = c("Observed", "Shannon", "Simpson"),
  color = "Depth", title = "16S Alpha diversity")

```

::: {.callout-note}
### ðŸ’¬ Discussion â€” Alpha diversity patterns

Observed richness (number of ASVs) tend to be increasing with depth.
:::

### Ordination

```{r, echo=FALSE, message=FALSE, warning=FALSE}
ord <- ordinate(ps_16s, method = "PCoA", distance = "bray")

# Create the ordination plot with ellipses
plot_ordination(ps_16s, ord, color = "Fjord") +
  geom_point(size = 3) +
  ggtitle("Ordination â€“ 16S") +
  stat_ellipse(aes(group = Fjord), type = "norm", linetype = "dashed", size = 1) +
  theme_minimal()
```
::: {.callout-note}
### ðŸ’¬ Discussion â€” Beta diversity

The ordination shows **clustering of samples by fjord**, indicating fjord-level structuring of bacterial communities. Sermilik forms a relatively distinct and tightly clustered group, whereas Tunulliarfik exhibits greater within-fjord variability. Notably, there is considerable overlap between Itterdalk and Tunulliarfik, suggesting partial similarity in community composition and potentially shared environmental controls. Ocean samples occupy an intermediate position, consistent with coastal waters acting as a regional microbial source pool. Overall, **fjord identity contributes to community differentiation**, although separation is not absolute among all systems.

Next: check if dispersion differs significantly? 
betadisper(...)
permutest(...)

**NOTE**: some samples are pretty distant from the othesr. Who are they?
:::

```{r, echo=FALSE, message=FALSE, warning=FALSE}
# Extract sample coordinates from the PCoA result
site <- as.data.frame(ord$vectors)
site$SampleID <- rownames(site)

# Get the 5 lowest values on Axis.1 (side of plot)
bottom5 <- site[order(site$Axis.1), ][1:5, c("SampleID", "Axis.1", "Axis.2")]
bottom5
```

::: {.callout-note}
The most divergent samples in the ordination correspond exclusively to surface (D1) samples. These stations were influenced by meltwater and low salinity conditions, suggesting that surface stratification and freshwater input may exert a strong effect on microbial community composition. This pattern indicates that vertical position and freshwater influence may be key drivers of community differentiation in these fjord systems.
:::


### Phylum composition

```{r echo=FALSE, message=FALSE, warning=FALSE}
# my_colors <- c("#FF6666", "#8DD3C7", "#377EB8", "#4DAF4A",  
#                "#984EA3", "#A6D854", "#FFFF33", "#FF7F00", "#F781BF", "#999999",                  "#66C2A5", "#FC8D62", "#8DA0CB", "#E78AC3", "#FFD92F", 
#                "#E5C494", "#B3B3B3", "#A65628","#FFFFB3", "#BEBADA", 
#                "#FB8072", "#80B1D3", "#FDB462")
# 
# library(microbiome)
# 
# # 1) Agglomerate to Phylum
# ps_phylum <- tax_glom(ps_16s, taxrank = "Phylum")
# 
# # 2) Transform to relative abundance (compositional)
# ps_rel <- microbiome::transform(ps_phylum, "compositional")
# 
# # 3) Top 20 taxa by mean relative abundance (returns taxa_names / OTU IDs)
# top20 <- microbiome::top_taxa(ps_rel, n = 20)
# 
# # 4) Melt full object
# df <- psmelt(ps_rel)
# 
# # Ensure Phylum label exists and is character (handles NAs)
# df <- df %>%
#   mutate(
#     Phylum = as.character(Phylum),
#     Phylum = if_else(is.na(Phylum) | Phylum == "", "Unassigned", Phylum),
#     Phylum_plot = if_else(OTU %in% top20, Phylum, "Other")
#   ) %>%
#   group_by(Sample, Number, Phylum_plot) %>%
#   summarise(Abundance = sum(Abundance), .groups = "drop")
# 
# # Put "Other" at the end of the legend
# df$Phylum_plot <- factor(
#   df$Phylum_plot,
#   levels = c(setdiff(unique(df$Phylum_plot), "Other"), "Other")
# )
# 
# # 5) Colors: 20 phyla + Other
# other_color <- "#C0C0C0"
# plot_colors <- c(my_colors[1:20], other_color)
# 
# # Optional: make sure color vector matches factor levels exactly
# levels_phyla <- levels(df$Phylum_plot)
# names(plot_colors) <- levels_phyla  # map colors to labels
# 
# # 6) Plot
# ggplot(df, aes(x = Number, y = Abundance, fill = Phylum_plot)) +
#   geom_col(width = 0.8) +
#   scale_fill_manual(values = plot_colors) +
#   scale_y_continuous(labels = scales::percent) +
#   labs(
#     title = "Bacteria/Archaea Phyla (Top 20 + Other)",
#     x = "Sample Number",
#     y = "Relative abundance (%)",
#     fill = "Phylum"
#   ) +
#   theme_classic() +
#   theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
#   scale_x_discrete(
#     labels = function(x) substr(x, 1, 5),
#     breaks = function(x) x[seq(1, length(x), by = 4)]
#   )

```

::: {.callout-note}
### ðŸ’¬ Discussion â€” 
:::

